const dgram = require('dgram');
const helper = require('../helper');


function send(host, port, data, handler) {
  let client = dgram.createSocket('udp4');
  client.on('error', (err) => {
    console.info(`UDP[ERROR] - ${err}`);
    client.close();
  });
  client.on('message', (fbMsg, fbRinfo) => {
    console.info(`UDP client[INFO] - received `, fbRinfo, fbMsg);
    handler && handler(fbMsg, fbRinfo);
    client.close();
  });
  console.info(`UDP client[INFO] - send to ${host}:${port}`);
  client.send(data, port, host, (err) => {
    if (err) {
      console.error(`UDP[ERROR] - ${err}`);
      client.close();
    }
  });
}

function testDNS() {
  const host = '114.114.114.114';
  const port = 53;
  const data = Buffer.from([0xbb, 0x12, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x6d, 0x75, 0x6d, 0x75, 0x03, 0x6e, 0x69, 0x65, 0x07, 0x6e, 0x65, 0x74, 0x65, 0x61, 0x73, 0x65, 0x03, 0x63, 0x6f, 0x6d, 0x00, 0x00, 0x01, 0x00, 0x01]);
  send(host, port, data);
}

function testLocalServer() {
  const host = '127.0.0.1';
  const port = 8000;
  const data = Buffer.from([0x00, 0x00, 0x00, 0x01, 0x72, 0x72, 0x72, 0x72, 0x00, 0x35, 0xbb, 0x12, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x6d, 0x75, 0x6d, 0x75, 0x03, 0x6e, 0x69, 0x65, 0x07, 0x6e, 0x65, 0x74, 0x65, 0x61, 0x73, 0x65, 0x03, 0x63, 0x6f, 0x6d, 0x00, 0x00, 0x01, 0x00, 0x01]);
  send(host, port, data, function(msg, info) {
    console.log(helper.parseSocks5UdpRequest(msg))
  });
}

testLocalServer();